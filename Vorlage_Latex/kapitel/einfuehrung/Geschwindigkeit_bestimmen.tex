\section{UDP Gewerk1 einlesen}
In diesem Subsystem wird per UDP alle Daten eingelesen, die an die IP des Robotinos adressiert sind.Der Aufbau des Subsystems ist in Abbildung \ref{fig:UDPGW1} gezeigt Die dabei eingelsesenen Daten wurden unter Kapitel \ref{} näher erläutert.
\begin{figure}
	\centering	\includegraphics[width=0.5\textwidth]{grafiken/Geschwindigkeit_bestimmen.png}
	\caption{Subsystem UDP Gewerk 1}
	\label{fig:UDPGW1}
\end{figure}

\section{UDP Daten formatieren}
In diesem Subsystem werden die eingelesenen UDP Datenvon der Fertigungsplanung aufgesplittet. Der Aufbau des Subsystems ist in Abbildung \ref{} dargestellt.

\begin{figure}
	\centering	\includegraphics[width=0.5\textwidth]{grafiken/Geschwindigkeit_bestimmen.png}
	\caption{Subsystem Vektorberechnung}
	\label{fig:Vektorberechnung}
\end{figure}

\section{Fehler erkennen}
In dieser Funktion wird sich der Fehlerstatus des Robotinos gemerkt und bei einem Resetsignal durch die Fertigungsplanung zurückgesetzt. Desweiteren wird der Fehler erkannt, dass ein Werkstück während des Transport verloren wird, erkannt.

\section{Auftrag steuern}
In diesem Stateflow wird das abarbeiten des Auftrags gesteuert, da wir von der Fertigungsplanung Aufträge gesendet bekommen die Startfach und Zielfach enthalten ist dies Notwendig.Das entwickelte Stateflow ist in Abbildung \ref{fig:Auftrag} dargestellt. Dabei ist der Startzustand auf einen neuen Auftrag warten. In diesem Zustand wird der Status auf Frei gesetzt. Wenn nun ein Auftrag eingegangen ist wird unterschieden ob der Robotino laden oder Transportieren soll. Wenn der Robotino Laden soll, wird als Ziel die Ladestation an die folgenden Funktionen übergeben. Wenn nun ein Signal von der Fertigungsplanung erhalten wird, dass der Robotino fertig geladen hat, wird der Status auf Ladenabgeschlossen gesetzt. Wenn sich nun der Robotino im Transportbereich befindet, also die Ladestation sicher verlassen wurde, wird wider auf einen neuen Auftrag gewartet. Wenn ein Auftrag erhalten wird, der zum Transport dient, wird der Zustand auf Arbeitend ohne Werkstück geändert. In diesem Zustand wird als Ziel das Startfach an die nachfolgenden Funktionen übergeben. Wenn nun ein Werkstück aufgenommen ist und sich der Robotino wider im Transportbereich befindet wird der Zusatnd auf Arbeotend mit Werkstück gesetzt. In diesem Zustand wird nun das Zielfach als Ziel an die nachfolgenden Funktionen übergeben. Wenn dann das Werkstück abgelegt ist, wird der Zustand auf Werkstück abgelegt geändert. Dieser Zustand wird verlassen, wenn der Robotino wider im Transportbereich ist und es kann wider ein neuer Auftrag begonnen werden.

\begin{figure}
	\centering	\includegraphics[width=0.5\textwidth]{grafiken/Geschwindigkeit_bestimmen.png}
	\caption{Stateflow Auftrag steuern}
	\label{fig:Auftrag}
\end{figure}


\section{Position der Robotinos bestimmen}
In dieser Funktion wird anhand der RobotinoID und der UDP Daten des Kamerasystems die Störposition (anderen Robotinos) bestimmt, sowie die eigene Position bestimmt. Da im laufe des Projektes Beobachterdaten durch die Bahnregelung generiert werden, wird die eigene Position nach dieser Funktion mit den Beobachterdaten überschrieben.

\section{Geschwindigkeit bestimmen}
Um die Sollgeschwindigkeit des Robotinos zu bestimmen, wird das Subsystem Vektorberechnung genutzt. Dieses Subsystem ist wie in Abbildung \ref{fig:Vektorberechnung} dargestellt, aufgebaut. Das Subsystem hat dabei den in Abbildung \ref{fig:AblVektor} gezeigten Ablauf. Dabei ist zu erkennen, dass zuerst die IR Daten erfasst werden und die fahrenden Robotinos erkannt werden. Die IR Datenerfassung wird unter Kapitel \ref{} näher erläutert. Wie die fahrenden Robotinos erkannt werden, wird in Kapitel \ref{} beschrieben. Anhand der IR Daten und der Informationen über die fahrenden Robotinos wird dann der Geschwindigkeitsvektor bestimmt. Die dabei genutzte Funktion wird unter Kapitel \ref{} beschrieben. Anhand des bestimmten Geschwindigkeitsvektors wird dann eine Ausweichrichtung bestimmt, wenn ein anderer Robotino die Route kreuzt. die dazu genutzte Funktion ist in Kapitel \ref{} näher beschrieben. Im nächsten Schritt wird dann das Ausweichmanöver ausgeführt. Die Implementierung des Ausweichmanövers wird in Kapitel \ref{} beschrieben.

\begin{figure}
	\centering	\includegraphics[width=0.5\textwidth]{grafiken/Geschwindigkeit_bestimmen.png}
	\caption{Subsystem Vektorberechnung}
	\label{fig:Vektorberechnung}
\end{figure}

\begin{figure}
	\centering	\includegraphics[width=0.5\textwidth]{grafiken/Geschwindigkeit_bestimmen.png}
	\caption{Ablaufplan des Subsystems Vektorberechnung}
	\label{fig:AblVektor}
\end{figure}

\subsection{IR Daten erfassen}
In der IR Daten erfassen Funktion werden zuerst die IR Daten aus den RobotinoDaten gefiltert und auf NaN gesetzt, wenn der gemessene Abstand größer als 150 mm ist. Bei einem Abstand kleiner gleich 150 mm wird die Position der Hindernisse in globalen Koordinaten bestimmt und ausgegeben.

\subsection{Fahrende Robotinos erkennen}
Um zu erkennen ob die anderen Robotinos fahren, werden die Postionen der Robotinos mit den Postionen vor einer Sekunde verglichen. Wenn die Robotinos mehr als 10 mm in der Sekunde zurückgelegt haben, wird der Robotino als fahrend gesetzt.

\subsection{Geschwindigkeitsvektor bestimmen}
In dieser Funktion wird das in Kapitel \ref{} beschriebene Potentialfeld zur Vektorberechnung umgesetzt. Dazu werden die in Kapitel \ref{} beschriebenen Funktionen abgeleitet und addiert. Die genutzten Ableitungen sind unter \ref{} bis \ref{}dargestellt. Dabei werden die Funktionen partiel nach x und y abgeleitet. In der Funktion \ref{} und \ref{} wird die Ableitung der Stationspotentialfeldes definiert. Diese Funktionen werden im Programm für die vier Stationen und die zwei Ladestation ausgeführt. Im nächsten Schritt wird der Zielvektor über die abgeleitete Funktion \ref{} und \ref{} bestimmt. Im nächsten Schritt werden die Robotino und IR Gradienten berechnet. Dazu wird die gleiche Funktion (\ref{} und \ref{}) wie bei der Stationsberechnung genutzt. Dabei werden jedoch die über die IR Daten erfassten Positionen, sowie die per Kameraudp erhaltenen Robotinopositionen genutzt. Im nächsten Schritt wird die aktuelle Robotinozone bestimmt und je nach Zone der Umweltgradient, nach den Funktionen \ref{} bis \ref{}, bestimmt. Da nicht alle Gradienten in allen Zonen genutzt werden, gibt es jeder Zone eine eigene Summe von Gradienten. Dabei wird zum Beispiel die Stationsgradienten der Stationen nur in Zone 4 und die Ladestationsgradienten nur in Zone 0 mit eingerechnet. Desweiteren wird der Zielgradienten nur in Zone 0 eingerechnet damit die Führung des Robotinos hinter den Statonen nicht gestört wird.

\begin{align}
Vx_{Stationen}=-K\cdot e^{-\frac{(x-Stationsposition_x)^2+(y-Stationsposition_y)^2}{2\cdot \sigma^2}} \cdot \frac{x-Stationsposition_x}{2\cdot \sigma^2}\\
Vy_{Stationen}=-K\cdot e^{-\frac{(x-Stationsposition_x)^2+(y-Stationsposition_y)^2}{2\cdot \sigma^2}} \cdot \frac{y-Stationsposition_y}{2\cdot \sigma^2}\\
Vx_{Ziel}=\frac{K\cdot(x-Ziel_x)}{\sqrt{(x-Ziel_x)^2+(y-Ziel_y)^2}}\\
Vy_{Ziel}=\frac{K\cdot(y-Ziel_y)}{\sqrt{(x-Ziel_x)^2+(y-Ziel_y)^2}}\\
Vx_{Umwelt}(Zone=0,x=0..5500,y=0..2500)=\frac{1}{\sigma}\cdot K \cdot e^{\frac{-x}{\sigma}} +\frac{-1}{\sigma}\cdot K \cdot e^{\frac{x-x_{max}}{\sigma}}\\
Vy_{Umwelt}(Zone=0,x=0..5500,y=0..2500)=\frac{-1}{\sigma} \cdot K \cdot e^{\frac{y-2500}{\sigma}} +\frac{1}{\sigma} \cdot K \cdot e^{\frac{-y}{\sigma}}\\
Vx_{Umwelt}(Zone=0,x=5500..x_{max},y=0..2500)=\frac{1}{\sigma}\cdot K \cdot e^{\frac{-(x-5500)+(y-2500)}{\sigma}} +\frac{-1}{\sigma}\cdot K \cdot e^{\frac{x-x_{max}}{\sigma}}\\
Vy_{Umwelt}(Zone=0,x=5500..x_{max},y=0..2500)=\frac{-1}{\sigma} \cdot K \cdot e^{\frac{-(x-5500)+(y-2500)}{\sigma}} +\frac{1}{\sigma} \cdot K \cdot e^{\frac{-y}{\sigma}}\\
Vx_{Umwelt}(Zone=0,x=5500..x_{max},y=2500..y_max)=\frac{1}{\sigma}\cdot K \cdot e^{-\frac{x-5500}{\sigma}} +\frac{-1}{\sigma}\cdot K \cdot e^{\frac{x-x_{max}}{\sigma}}\\
Vy_{Umwelt}(Zone=0,x=5500..x_{max},y=2500..y_{max})=\frac{-1}{\sigma} \cdot K \cdot e^{\frac{y-y_{max}}{\sigma}} +\frac{1}{\sigma} \cdot K \cdot e^{\frac{-y}{\sigma}}\\
Vx_{Umwelt}(Zone=1)=K_{gerade}\\
Vy_{Umwelt}(Zone=1)=-2\cdot \frac{y-3500}{K_{parabel}}\\
Vx_{Umwelt}(Zone=2)=-K_{gerade}\\
Vy_{Umwelt}(Zone=2)=-2\cdot \frac{y-3500}{K_{parabel}}\\
Vx_{Umwelt}(Zone=3)=-2\cdot \frac{x-300}{K_{parabel}}\\
Vy_{Umwelt}(Zone=3)=-K_{gerade}\\
Vx_{Umwelt}(Zone=4)=0\\
Vy_{Umwelt}(Zone=4)=K_{gerade}\\
Vx_{Umwelt}(Zone=5)=-2\cdot \frac{x-5500}{K_{parabel}}\\
Vy_{Umwelt}(Zone=5)=-K_{gerade}
 \end{align}

\subsection{Ausweichrichtung bestimmen}
Um eine Ausweichrichtung zu bestimmen, wird zuerst der Abstand zu den anderen Robotinos anhand derer Positionen bestimmt. Wenn der Abstand geringer als ein Meter ist, wird der globale Winkel zum Robotino bestimmt und um \(90^°\) erhöht. Zusätzlich wird im nächsten Schritt der Fahrwinkel anhand des Geschwindigkeitsvektors in globalen Koordinaten bestimmt. Anhand des Fahrwinkels und der Robotinowinkel wird dann ein Enable-Bit gesetzt wenn sich der Robotino in einem Toleranzbereich um den Fahrwinkel befindet. Wenn dieses Enable-Bit nicht gesetzt ist, wird kein Ausweichmanöver ausgeführt.

\subsection{Ausweichmanöver addieren}
In dieserFunktion wird nun auf das Ausweichmanöver auf den Geschwindigkeitsvektor addiert wenn das Enable-Bit aus der Ausweichrichtungsbestimmung gesetzt ist. Desweiteren wird das Ausweichmanöver nicht ausgeführt wenn sich der Robotino nicht in der Hauptfahrzone (Zone=0) befindet oder sich der Robotino nicht im FIFO-Bereich oder nahe am Ziel (Distanz >300mm) befindet.
Zusätzlich wird in dieser Funktion die Abbremsfilterung integriert, wie im Kapitel \ref{} beschrieben, wird dazu ein distanzabhängiger Faktor multipliziert.

\section{Fahrmodus steuern}
Diese Stateflow, welches in Abbildung \ref{fig:Fahrmodus} dargestellt ist, steuert die Kommunikation mit der Bahnregelungsgruppe. Beim Start ist der Transportbereich aktiv in dem die Potentialfeldmethode zum Regeln genutzt wird. Wenn der Robotino über das Potentialfeld sein Ziel erreicht hat, wird an die Bahnregelung, über das setzen des Fertigungsbereich auf eins, übergeben. Wenn das Ziel eine Ladestation ist, wird der Bahnregelung die Zielladestationsposition übergeben. Wenn der Robotino fertig geladen hat, wird der Bahnregelung wieder der Übergabepunkt als Ziel gegeben und wieder auf den Transportbereich gewechselt.\\
Wenn das Ziel eine Ladestation ist werden zwei varianten unterschieden. Die erste Möglichkeit besteht darin ein Werkstück aufzunehmen. Dabei wird zuerst die Werkstueckposition übergeben. Nach der Bestätigung von der Bahnregelung des erfolgreichen aufnehmens, wird der RFID-Leser als Ziel vorgegeben. Wenn die Bahnregelung die Position bestätigt, wird auf eine Bestätigung, desRFID-Schreibens, durch die Fertigungsplannung gewartet. Nach dieser Bestätgung wird der Bahnregelung ein Übergabepunkt vorgegeben an dem zur Potentialfeldmethode gewechselt werden soll. Dabei besteht die Möglichkeit nach hinten abzugeben, wenn ein Robotino auf die Station wartet oder nach vorne abzugeben wenn kein Robotino in die Station möchte.\\
Im zweiten Fall soll ein Werkstück in der Station abgegeben werden. Dabei ändert sich Reihenfolge der Ziele auf als erstes zum RFID-Leser und auf bestätigung von Fertigungsplanung warten. Als nächstes die Zielposition für das Werkstück und wieder die Ausfahrposition.\\
In diesem Stateflow erfolgt zusätzlich die Statuszuweisung des Robotinos und dessen Fehlererkennung.

\begin{figure}
	\centering	\includegraphics[width=1\textwidth]{grafiken/KommunikationGewerk3.pdf}
	\caption{Fahrmodus steuern}
	\label{fig:Fahrmodus}
\end{figure}

\section{Geschwindigkeit begrenzen}
In dieser Funktion wird eine gleitende Mittelwertbildung über 100 Werte vorgenommen um die Geschwindigkeitsvorgabe zu glätten.  Nach der Filterung wird die Geschwindigkeit je nach Position begrenzt. Dabei wird die Geschwindigkeit bei den FIFO-Positionen auf 300mm/s begrenzt und in der Hauptfahrzone auf 700mm/s.

\section{Geschwindigkeit transformieren}
In dieser Funktion wird der globale Geschwindigkeitsvektor auf das Robotinokoordinatensystem über den Winkel des Robotinos transformiert. Dazu wird eine Rotationsmatrix genutzt. Da der Robotino den negativen Gradienten in mm/s als vorgabe benötigt, wird der Geschwindigkeitsvektor vor diesem Funktionblock mit -1000 multipliziert, da durch unsere Berechnung der positive Gradent in m/s ermittelt wird.

\section{Status bestimmen}
In dieser Funktion wird der Status des Robotinos, der an die Fertigungsplanung übergeben wird, bestimmt. Dabei wird der Status der in der Fahrmodussteuerung unter Kaptel \ref{} direkt übergeben wenn kein Fehler durch die Bahnregelung registriert wird.

\section{UDP Gewerk1 schreiben}
In diesem Subsystem wird die UDP-Kommunikation mit der Fertigungsplanung realisiert, dazu werden die zu sendenden Daten gepackt und per UDP an alle im Netzwerk geschickt. Der Aufbau des Subsystems ist in Abbildung \ref{} unter Kapitel \ref{} gezeigt. Dazu wird für jeden Robotino ein eigener Port definiert.Die Schnittstelle unter Kapitel \ref{} näher erläutert.






